# `TIME_WAIT`与连接池

## 如何查看网络状态

1、查看服务器上各个状态的统计数量

```
netstat -ant | awk '/^tcp/ {++y[$NF]} END {for(w in y) print w, y[w]}'
#结果：
LISTEN 12
ESTABLISHED 42
TIME_WAIT 1
```

2、 单独查看TIME_WAIT，

```
ss -nat | grep TIME-WAIT
#结果：
TIME-WAIT  0      0      172.16.163.163:58376              100.100.167.125:443
TIME-WAIT  0      0      172.16.163.163:44030              100.100.45.106:443
TIME-WAIT  0      0      127.0.0.1:65513              127.0.0.1:52120
```

## 什么是`TIME_WAIT`？

![四次挥手](D:\www\Snail\Go专题系列\images\Tcp20201216format,png)

TCP通过四次挥手进行连接的断开：

1. 当客户端或服务器其中一方想主动关闭连接时，主动关闭方就会进入`FIN_WAIT1`状态，被动关闭方收到FIN包后进入`CLOSE_WAIT`状态，并返回`ACK`包。
2. 被动关闭方，需要调用系统的close方法回收socket资源，这个时候系统发送FIN包给主动关闭方，并且被动关闭方进入到`LAST_ACK`状态。
3. 主动关闭方收到FIN包后进入到`TIME_WAIT`状态，并回复`ACK`包，然后超时**2MSL**个时间(大概为2分钟，不同系统和环境配置可能不一样)后，
4. 主动关闭方进入到`CLOSED`状态，彻底回收socket资源。被动关闭方收到`ACK`包后，从`LAST_ACK`状态进入到最终的`CLOSED`状态。

需要注意的是：

- `TIME_WAIT`状态**只在主动关闭方出现**，这个主动关闭方可能是客户端，也有可能是服务器。`TIME_WAIT`状态的消失只能通过**2MSL**时间转换为CLOSED状态后消失。无法人工删除，因为这是一个非常谨慎的[TCP设计方案](http://blog.csdn.net/benjiazhen/article/details/53187568)，最好不要通过修改系统参数来避免这个**2MSL**的等待时间。
- `CLOSE_WAIT`状态就简单得多，就是被动关闭方收到主动关闭方的FIN包时就会进入，只要被动关闭方调用close关闭socket就能马上进入`LAST_ACK`状态。

## TIME_WAIT的作用

## TIME_WAIT会影响什么





## Go连接池(以HTTP连接池举例)

### TIME_WAIT还是过多？

- http.Client中没有设置[MaxIdleConnsPerHost](https://studygolang.com/articles/11050?fr=sidebar)，如果你的httpclient后端只有有限的几个host的服务器，由于默认的MaxIdleConnsPerHost只设置为2，这代表，大部分的持久连接都会在完成请求后，会被http.Client主动关闭，导致大量的TIME_WAIT事件发生。如果MaxIdleConnsPerHost设置得比较大，这些连接请求完成后则会被http.Client放进连接池中留作下次使用，不会去主动关闭，大大减少短连接的使用，避免了TIME_WAIT事件的发生。
- http.Server中直接连前端的浏览器，没有经过中转网关。这样会导致大量设计不良的爬虫直接使用短连接连接server。由于这些请求都是带上Connection: close参数，导致http.Server主动关闭这些短连接，使得服务器大量留下了TIME_WAIT状态。解决方法很简单，让http.Server前面建立一个nginx网关，将短连接转换为长连接来连接后端的golang服务，这样这些TIME_WAIT状态会耗费在网关层，而不是在服务层。
- http.Server中连接第三方服务时没有使用连接池，第三方服务例如redis，mysql,rabbitmq这种，然后每个操作都是使用短连接来操作，用完就主动关闭，这样会大大增加server端的TIME_WAIT状态，耗费了大量的端口资源。解决办法，就是用连接池了，没什么好说的。



需要搞懂的：

TIME_WAIT：https://www.cnblogs.com/rexcheny/p/11143128.html

可能遇到的问题

https://www.dazhuanlan.com/2019/12/13/5df2e64445102/

http://xiaorui.cc/archives/5056

