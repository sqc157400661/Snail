# go语言unsafe库总结

## Go指针

在正式介绍 unsafe 包之前，需要着重介绍 Go 语言中的指针类型。先看一段代码：

```go
package main

import "fmt"

func double(x *int) {
	*x += *x
	x = nil
}

func main() {
	var a = 3
	double(&a)
	fmt.Println(a) // 6
	
	p := &a
	double(p)
	fmt.Println(a, p == nil) // 12 false
}
```

很常规的操作，不用多解释。唯一可能有些疑惑的在这一句：`x = nil`

- 因为 Go 语言的函数传参都是`值传递`。所以 x 也只是对 &a 的一个拷贝。
- `*x += *x`这一句把 x 指向的值（也就是 &a 指向的值，即变量 a）变为原来的 2 倍。但是对 x 本身（一个指针）的操作却不会影响外层的 a，所以 `x = nil` 掀不起任何大风大浪。

<img src="D:\www\Snail\Go专题系列\images\unsafe-2.png" alt="pointer copy"  />

相比于 C 语言中指针的灵活，Go 的指针多了一些限制。但这也算是 Go 的成功之处：既可以享受指针带来的便利，又避免了指针的危险性。

限制一：`Go 的指针不能进行数学运算`

```go
a := 5
p := &a
p++
p = &a + 3
```

上面的代码将不能通过编译，会报编译错误：`invalid operation`，也就是说不能对指针做数学运算。

限制二：`不同类型的指针不能相互转换`。

```go
func main() {	
    a := int(100)	
    var f *float64		
    f = &a
}
```

参考：

1. https://qcrao.com/2019/06/03/dive-into-go-unsafe/
2. https://www.flysnow.org/2017/07/06/go-in-action-unsafe-pointer.html
3. https://studygolang.com/articles/5951
4. https://blog.csdn.net/itpika/article/details/104180513
5. https://juejin.cn/post/6844903743180242951
6. http://www.verydoc.net/go/00003995.html

